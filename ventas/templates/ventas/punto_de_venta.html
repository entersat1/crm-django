<<<<<<< HEAD
{% extends 'base.html' %}
{% load static %}

{% block title %}Punto de Venta{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1>Punto de Venta</h1>
    
    <input type="hidden" id="cotizacion-dolar" value="{{ valor_dolar_actual }}">

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Detalle de Venta</h6>
                </div>
                <div class="card-body">
                    
                    <div class="form-group row">
                        <label for="cliente-select" class="col-sm-2 col-form-label">Cliente</label>
                        <div class="col-sm-10">
                            <select id="cliente-select" class="form-control">
                                <option value="">Venta de Mostrador</option>
                                {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <hr>

                    <div class="form-row align-items-end">
                        <div class="col">
                            <label for="producto-select">Producto</label>
                            <select id="producto-select" class="form-control">
                                <option value="">Seleccione un producto...</option>
                                {% for producto in productos %}
                                    <option value="{{ producto.id }}" data-stock="{{ producto.stock_actual }}">{{ producto.nombre }} (Stock: {{ producto.stock_actual }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-2">
                            <label for="cantidad-input">Cantidad</label>
                            <input type="number" id="cantidad-input" class="form-control" value="1" min="1">
                        </div>
                        <div class="col-auto">
                            <button id="add-producto" class="btn btn-primary">Agregar</button>
                        </div>
                    </div>

                    <hr>

                    <div class="table-responsive">
                        <table class="table table-bordered" id="carrito-tabla">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio (USD)</th>
                                    <th>Subtotal (ARS)</th>
                                    <th>Quitar</th>
                                </tr>
                            </thead>
                            <tbody id="carrito-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Resumen de Venta</h6>
                </div>
                <div class="card-body">
                    <h4 class="text-right">Total:</h4>
                    <h2 class="text-right font-weight-bold" id="total-pesos">$ 0.00</h2>
                    <hr>
                    <button id="finalizar-venta" class="btn btn-success btn-lg btn-block">
                        Finalizar Venta
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 1. REFERENCIAS A ELEMENTOS DEL DOM ---
    const productoSelect = document.getElementById('producto-select');
    const cantidadInput = document.getElementById('cantidad-input');
    const addProductoBtn = document.getElementById('add-producto');
    const carritoBody = document.getElementById('carrito-body');
    const totalPesosEl = document.getElementById('total-pesos');
    const clienteSelect = document.getElementById('cliente-select');
    const finalizarVentaBtn = document.getElementById('finalizar-venta');
    
    // Obtenemos el valor del dólar que pasamos desde Django
    const cotizacionDolar = parseFloat(document.getElementById('cotizacion-dolar').value);
    
    // El 'cerebro' de nuestro carrito en JavaScript
    let carrito = {}; 

    // --- 2. EVENTO CLICK PARA AGREGAR PRODUCTOS ---
    addProductoBtn.addEventListener('click', () => {
        const productoId = productoSelect.value;
        const cantidad = parseInt(cantidadInput.value);
        
        if (!productoId || cantidad <= 0) {
            alert('Por favor, seleccione un producto y una cantidad válida.');
            return;
        }

        // Evitar duplicados (mejor sumar cantidad si ya existe)
        if (carrito[productoId]) {
            alert('El producto ya está en el carrito. Puede modificar la cantidad allí.');
            return;
        }

        // Usamos la API que ya tenías creada en tus views
        fetch(`/ventas/api/productos/${productoId}/precio/`)
            .then(response => response.json())
            .then(data => {
                // Guardamos los datos en nuestro 'cerebro'
                carrito[productoId] = {
                    id: productoId,
                    nombre: data.nombre,
                    cantidad: cantidad,
                    precio_usd: data.precio_venta_usd
                };
                actualizarTablaCarrito();
            })
            .catch(error => console.error('Error al obtener precio:', error));
    });

    // --- 3. FUNCIÓN PARA REDIBUJAR LA TABLA Y TOTALES ---
    function actualizarTablaCarrito() {
        carritoBody.innerHTML = ''; // Limpiamos la tabla
        let totalGeneralPesos = 0;

        // Recorremos el 'cerebro' y creamos las filas
        for (const productoId in carrito) {
            const item = carrito[productoId];
            
            // ✅ AQUÍ ESTÁ LA LÓGICA DE CÁLCULO EN TIEMPO REAL
            const precioUSD = parseFloat(item.precio_usd);
            const cantidad = parseInt(item.cantidad);
            const subtotalPesos = (precioUSD * cantidad) * cotizacionDolar;

            totalGeneralPesos += subtotalPesos;

            const fila = `
                <tr data-id="${productoId}">
                    <td>${item.nombre}</td>
                    <td>${cantidad}</td>
                    <td>$ ${precioUSD.toFixed(2)}</td>
                    <td>$ ${subtotalPesos.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm btn-quitar" data-id="${productoId}">X</button>
                    </td>
                </tr>
            `;
            carritoBody.innerHTML += fila;
        }

        // ✅ AQUÍ SE REFLEJA LA SUMA TOTAL
        totalPesosEl.innerText = `$ ${totalGeneralPesos.toFixed(2)}`;
    }

    // --- 4. EVENTO PARA QUITAR PRODUCTOS ---
    carritoBody.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-quitar')) {
            const productoId = e.target.dataset.id;
            delete carrito[productoId]; // Lo borramos del 'cerebro'
            actualizarTablaCarrito(); // Redibujamos todo
        }
    });

    // --- 5. EVENTO PARA FINALIZAR LA VENTA ---
    finalizarVentaBtn.addEventListener('click', () => {
        if (Object.keys(carrito).length === 0) {
            alert('El carrito está vacío.');
            return;
        }

        const ventaData = {
            cliente: clienteSelect.value,
            carrito: carrito
        };

        // Obtenemos el CSRF token para Django
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('{% url "registrar_venta" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(ventaData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`¡Venta registrada con éxito! ID de Venta: ${data.venta_id}`);
                // Limpiamos todo
                carrito = {};
                actualizarTablaCarrito();
                clienteSelect.value = '';
            } else {
                alert(`Error al registrar la venta: ${data.message}`);
            }
        })
        .catch(error => console.error('Error en fetch:', error));
    });

});
</script>
=======
<!-- ventas/templates/ventas/punto_de_venta.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Punto de Venta{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1>Punto de Venta</h1>
    <div class="row">
        <div class="col-md-8">
            <!-- Aquí va la interfaz del punto de venta -->
            <div class="card">
                <div class="card-header">
                    <h5>Productos</h5>
                </div>
                <div class="card-body">
                    <p>Interfaz de punto de venta en construcción...</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <!-- Aquí va el resumen de la venta -->
            <div class="card">
                <div class="card-header">
                    <h5>Resumen de Venta</h5>
                </div>
                <div class="card-body">
                    <p>Resumen de la venta actual...</p>
                </div>
            </div>
        </div>
    </div>
</div>
>>>>>>> 221a76dd27c1c9ad53cabb1d52123a32be198d53
{% endblock %}